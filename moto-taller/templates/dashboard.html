<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moto-Taller - Sistema de Gestión</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-motorcycle"></i>
                <span>Moto-Taller</span>
            </div>
            <nav class="sidebar-nav">

                <!-- Administrador y Asesor pueden gestionar clientes -->
                {% if session['rol'] in ['administrador', 'asesor'] %}
                <a href="#" class="nav-link active" data-section="clientes">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
                {% endif %}

                <!-- Administrador, Asesor y Técnico pueden ver órdenes -->
                {% if session['rol'] in ['administrador', 'asesor', 'tecnico'] %}
                <a href="#" class="nav-link" data-section="ordenes">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Órdenes</span>
                </a>
                {% endif %}

                <!-- Solo el Administrador puede gestionar servicios -->
                {% if session['rol'] == 'administrador' %}
                <a href="#" class="nav-link" data-section="servicios">
                    <i class="fas fa-tools"></i>
                    <span>Servicios</span>
                </a>

                <!-- Administrador y Asesor pueden gestionar Factura -->
                {% if session['rol'] in ['administrador', 'asesor'] %}
                <a href="#" id="menu-facturacion" class="nav-link active" data-section="factura">
                    <i class="fas fa-file-invoice"></i>
                    <span>Facturación</span>
                </a>

                {% endif %}


                <!-- Solo el Administrador puede gestionar inventario -->
                {% if session['rol'] == 'administrador' %}
                <a href="#" class="nav-link" data-section="inventario">
                <i class="fas fa-boxes"></i>
                <span>Inventario</span>
                </a>
                {% endif %}



                <!-- Solo el Administrador puede ver reportes -->
                <a href="#" class="nav-link" data-section="reportes">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </a>

                <!-- Solo el Administrador puede acceder a configuración -->
                <a href="#" class="nav-link" data-section="configuracion">
                    <i class="fas fa-cog"></i>
                    <span>Configuración</span>
                </a>
                {% endif %}
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Sección: Gestión de Clientes -->
            <!-- Visible para: Administrador y Asesor -->
            {% if session['rol'] in ['administrador', 'asesor'] %}
            <section class="content-section" id="clientes-section">
                <header class="content-header">
                    <h1><i class="fas fa-users"></i> Gestión de Clientes</h1>
                    <div class="header-actions">
                        <div class="search-bar">
                            <input type="text" placeholder="Buscar cliente...">
                            <button class="search-btn"><i class="fas fa-search"></i></button>
                        </div>

                        <!-- Botón "Nuevo Cliente" solo visible para Administrador -->
                        {% if session['rol'] == 'administrador' %}
                        <button class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nuevo Cliente
                        </button>
                        {% endif %}
                    </div>
                </header>

                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table">
                            <!-- Tabla de clientes aquí... -->
                        </table>
                    </div>
                    <div class="table-footer">
                        <div class="pagination">
                            <!-- Paginación aquí... -->
                        </div>
                    </div>
                </div>
            </section>
            {% endif %}

            <!-- Sección: Gestión de Órdenes -->
            <!-- Visible para: Administrador, Asesor y Técnico -->
           <!-- Sección: Gestión de Órdenes -->
<!-- Visible para: Administrador, Asesor y Técnico -->
{% if session['rol'] in ['administrador', 'asesor', 'tecnico'] %}
<section class="content-section hidden" id="ordenes-section">
    <header class="content-header">
        <h1><i class="fas fa-clipboard-list"></i> Gestión de Órdenes</h1>
        <div class="header-actions">
            <div class="search-bar">
                <input type="text" placeholder="Buscar órdenes...">
                <button class="search-btn"><i class="fas fa-search"></i></button>
            </div>

            <!-- Crear orden: solo Administrador y Asesor -->
            {% if session['rol'] in ['administrador', 'asesor'] %}
            <a href="{{ url_for('orden.nueva_orden') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nueva Orden
            </a>
            {% endif %}
        </div>
    </header>

    <div class="card">
        <div class="order-cards">
            {% for orden in ordenes %}
            <div class="order-card status-{{ orden.estado | lower }}">
                <div class="order-header">
                    <span class="order-id">#ORD-{{ orden.id }}</span>
                    <span class="order-status">{{ orden.estado }}</span>
                </div>
                <div class="order-body">
                    <div class="order-info">
                        <span><i class="fas fa-user"></i> {{ orden.cliente.nombre }}</span>
                        <span><i class="fas fa-motorcycle"></i> {{ orden.moto.modelo }}</span>
                        <span><i class="fas fa-calendar"></i> {{ orden.fecha_entrada.strftime('%d/%m/%Y') }}</span>
                    </div>
                    <div class="order-actions">
                        <a href="#" class="btn btn-sm btn-icon" title="Ver"><i class="fas fa-eye"></i></a>
                        <a href="#" class="btn btn-sm btn-icon" title="Editar"><i class="fas fa-edit"></i></a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}


            <!-- Sección: Servicios -->
            <!-- Visible solo para: Administrador -->
            {% if session['rol'] == 'administrador' %}
            <section class="content-section hidden" id="servicios-section">
                <header class="content-header">
                    <h1><i class="fas fa-tools"></i> Servicios</h1>
                    <!-- Contenido interno de servicios... -->
                </header>
            </section>

   <!-- Sección: Inventario -->
{% if session['rol'] in ['administrador', 'asesor'] %}
<section class="content-section hidden" id="inventario-section">
    <header class="content-header">
        <h1>Gestión de Inventario</h1>
        <form method="POST">
            <label for="producto">Nombre :</label>
            <input type="text" name="Nombre" id="Nombre" required>

            <label for="cantidad">Referencia:</label>
            <input type="number" name="Referencia" id="Referencia" required min="1">

            <label for="precio"> Cantidad :</label>
            <input type="number" step="0.01" name="Cantidad" id="Cantidad" required>

             <label for="precio"> Precio :</label>
            <input type="number" step="0.01" name="precio" id="precio" required>


            <button type="submit">Agregar al Inventario</button>
        </form>
    </header>
</section>
{% endif %}

<!-- Sección: Reportes -->
<section class="content-section hidden" id="reportes-section">
    <header class="content-header">
        <h1><i class="fas fa-chart-bar"></i> Reportes</h1>
        <!-- Contenido interno de reportes... -->
    </header>
</section>

<!-- Sección: Configuración -->
<section class="content-section hidden" id="configuracion-section">
    <header class="content-header">
        <h1><i class="fas fa-cog"></i> Configuración</h1>
        <!-- Contenido interno de configuración... -->
    </header>
</section>

</main>
</div>

             <!-- Sección: Facturación -->
            {% if session['rol'] in ['administrador', 'asesor'] %}
            <section class="content-section hidden" id="factura-section">
                <header class="content-header">
                    <h1>Generar Factura</h1>
                     <form method="POST">
                        <label for="orden_id">Orden:</label>
                         <select name="orden_id" required>
            {% for orden in ordenes %}
                <option value="{{ orden.id }}">Orden #{{ orden.id }} - {{ orden.cliente }} ({{ orden.placa }})</option>
            {% endfor %}
             </select>

        <label for="subtotal">Subtotal:</label>
        <input type="number" step="0.01" name="subtotal" required>

        <button type="submit">Generar Factura</button>

           
    </form>
                </header>
            </section>
            {% endif %}


            <!-- Sección: Reportes -->
            <section class="content-section hidden" id="reportes-section">
                <header class="content-header">
                    <h1><i class="fas fa-chart-bar"></i> Reportes</h1>
                    <!-- Contenido interno de reportes... -->
                </header>
            </section>

            <!-- Sección: Configuración -->
            <section class="content-section hidden" id="configuracion-section">
                <header class="content-header">
                    <h1><i class="fas fa-cog"></i> Configuración</h1>
                    <!-- Contenido interno de configuración... -->
                </header>
            </section>
            {% endif %}
        </main>
    </div>
    <script>
        // Variables globales
        let repuestos = [];
        let searchTimeout;
        let nextId = 1;

        // Datos de demostración
        const datosDemo = [
            { id: 1, nombre: "Filtro de Aceite", marca: "Honda", referencia: "15410-MEN-A01", cantidad: 25, precio: 15000 },
            { id: 2, nombre: "Pastillas de Freno", marca: "Yamaha", referencia: "5SL-W0045-00", cantidad: 8, precio: 45000 },
            { id: 3, nombre: "Cadena 428", marca: "DID", referencia: "428HD-120", cantidad: 0, precio: 85000 },
            { id: 4, nombre: "Bujía", marca: "NGK", referencia: "CR8E", cantidad: 50, precio: 12000 },
            { id: 5, nombre: "Aceite 4T", marca: "Castrol", referencia: "15W40-1L", cantidad: 15, precio: 18000 }
        ];

        // Cargar datos de demostración al inicio
        function cargarDatosDemo() {
            repuestos = [...datosDemo];
            nextId = Math.max(...repuestos.map(r => r.id)) + 1;
        }

        // Mostrar alerta
        function mostrarAlerta(mensaje, tipo) {
            const alert = document.getElementById('alert');
            alert.textContent = mensaje;
            alert.className = `alert alert-${tipo}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // Calcular estadísticas
        function calcularEstadisticas() {
            const stats = {
                total_repuestos: repuestos.length,
                stock_bajo: repuestos.filter(r => r.cantidad > 0 && r.cantidad < 10).length,
                sin_stock: repuestos.filter(r => r.cantidad === 0).length,
                valor_total: repuestos.reduce((total, r) => total + (r.cantidad * r.precio), 0)
            };

            document.getElementById('totalRepuestos').textContent = stats.total_repuestos;
            document.getElementById('stockBajo').textContent = stats.stock_bajo;
            document.getElementById('sinStock').textContent = stats.sin_stock;
            document.getElementById('valorTotal').textContent = new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP'
            }).format(stats.valor_total);
        }

        // Cargar repuestos (simulación de API)
        function cargarRepuestos(search = '') {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('inventoryTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            
            // Simular delay de red
            setTimeout(() => {
                let repuestosFiltrados = repuestos;
                
                if (search) {
                    const searchLower = search.toLowerCase();
                    repuestosFiltrados = repuestos.filter(r => 
                        r.nombre.toLowerCase().includes(searchLower) ||
                        r.marca.toLowerCase().includes(searchLower) ||
                        r.referencia.toLowerCase().includes(searchLower)
                    );
                }
                
                renderizarTabla(repuestosFiltrados);
                calcularEstadisticas();
                
                document.getElementById('loadingIndicator').style.display = 'none';
                
                if (repuestosFiltrados.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('inventoryTable').style.display = 'none';
                } else {
                    document.getElementById('inventoryTable').style.display = 'table';
                }
            }, 300);
        }

        // Renderizar tabla
        function renderizarTabla(repuestosAMostrar = repuestos) {
            const tbody = document.getElementById('repuestosTableBody');
            tbody.innerHTML = '';

            repuestosAMostrar.forEach(repuesto => {
                const row = document.createElement('tr');
                
                // Agregar clases para indicar stock
                if (repuesto.cantidad === 0) {
                    row.classList.add('out-of-stock');
                } else if (repuesto.cantidad < 10) {
                    row.classList.add('low-stock');
                }

                row.innerHTML = `
                    <td>${repuesto.id}</td>
                    <td>${repuesto.nombre}</td>
                    <td>${repuesto.marca}</td>
                    <td>${repuesto.referencia}</td>
                    <td>${repuesto.cantidad}</td>
                    <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(repuesto.precio)}</td>
                    <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(repuesto.cantidad * repuesto.precio)}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editarRepuesto(${repuesto.id})">Editar</button>
                        <button class="btn btn-danger" onclick="eliminarRepuesto(${repuesto.id})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Manejar formulario
        function manejarFormulario(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const repuesto = {
                nombre: formData.get('nombre').trim(),
                marca: formData.get('marca').trim(),
                referencia: formData.get('referencia').trim(),
                cantidad: parseInt(formData.get('cantidad')),
                precio: parseFloat(formData.get('precio'))
            };

            // Validaciones
            if (!repuesto.nombre || !repuesto.marca || !repuesto.referencia) {
                mostrarAlerta('Todos los campos son requeridos', 'error');
                return;
            }

            const editId = document.getElementById('editId').value;

            try {
                if (editId) {
                    // Actualizar repuesto existente
                    const index = repuestos.findIndex(r => r.id === parseInt(editId));
                    if (index !== -1) {
                        repuestos[index] = { ...repuesto, id: parseInt(editId) };
                        mostrarAlerta('Repuesto actualizado exitosamente', 'success');
                    }
                } else {
                    // Verificar si ya existe la referencia
                    if (repuestos.find(r => r.referencia === repuesto.referencia)) {
                        mostrarAlerta('Ya existe un repuesto con esa referencia', 'error');
                        return;
                    }
                    
                    // Crear nuevo repuesto
                    repuesto.id = nextId++;
                    repuestos.push(repuesto);
                    mostrarAlerta('Repuesto agregado exitosamente', 'success');
                }

                e.target.reset();
                if (editId) {
                    cancelEdit();
                }
                cargarRepuestos();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al procesar la solicitud', 'error');
            }
        }

        // Editar repuesto
        function editarRepuesto(id) {
            const repuesto = repuestos.find(r => r.id === id);
            if (repuesto) {
                document.getElementById('editId').value = repuesto.id;
                document.getElementById('nombre').value = repuesto.nombre;
                document.getElementById('marca').value = repuesto.marca;
                document.getElementById('referencia').value = repuesto.referencia;
                document.getElementById('cantidad').value = repuesto.cantidad;
                document.getElementById('precio').value = repuesto.precio;
                
                document.getElementById('submitBtn').textContent = 'Actualizar Repuesto';
                document.getElementById('cancelBtn').style.display = 'inline-block';
                
                // Scroll al formulario
                document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Cancelar edición
        function cancelEdit() {
            document.getElementById('editId').value = '';
            document.getElementById('repuestoForm').reset();
            document.getElementById('submitBtn').textContent = 'Agregar Repuesto';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        // Eliminar repuesto
        function eliminarRepuesto(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este repuesto?')) {
                try {
                    const index = repuestos.findIndex(r => r.id === id);
                    if (index !== -1) {
                        repuestos.splice(index, 1);
                        mostrarAlerta('Repuesto eliminado exitosamente', 'success');
                        cargarRepuestos();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    mostrarAlerta('Error al eliminar el repuesto', 'error');
                }
            }
        }

        // Filtrar repuestos
        function filtrarRepuestos() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('searchInput').value;
                cargarRepuestos(searchTerm);
            }, 300);
        }

        // Event listeners
        document.getElementById('repuestoForm').addEventListener('submit', manejarFormulario);
        document.getElementById('searchInput').addEventListener('input', filtrarRepuestos);

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatosDemo();
            cargarRepuestos();
            mostrarAlerta('Sistema de inventario cargado correctamente', 'success');
        });
    </script>
</body>
</html>
    <script>   
    document.querySelectorAll('.sidebar-nav .nav-link').forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();

            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Mostrar la sección correspondiente al data-section
            const targetId = this.getAttribute('data-section') + '-section';
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
        });
    });
</script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    
</body>
</html>
